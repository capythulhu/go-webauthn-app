<!DOCTYPE html>
<html>
<head>
    <title>Go WebAuthn App</title>
</head>
<body>
    <h1>Go WebAuthn App</h1>

    <button onclick="register()">Register Passkey</button>
    <button onclick="login()">Login with Passkey</button>

    <script>
        function bufferToBase64url(buffer) {
            // Convert a buffer to a Base64URL encoded string
            return btoa(String.fromCharCode(...new Uint8Array(buffer)))
                .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        function base64urlToBuffer(base64urlString) {
            // Convert a Base64URL encoded string to a buffer
            const padding = '='.repeat((4 - base64urlString.length % 4) % 4);
            const base64 = (base64urlString + padding)
                .replace(/-/g, '+')
                .replace(/_/g, '/');
            const rawData = atob(base64);
            return Uint8Array.from([...rawData].map((char) => char.charCodeAt(0)));
        }

        async function register() {
            try {
                const response = await fetch('/register/begin', { method: 'POST' });
                const options = await response.json();

                // Extract the publicKey options from the response
                const publicKeyOptions = options.publicKey;

                // Convert Base64URL strings to ArrayBuffers
                publicKeyOptions.challenge = base64urlToBuffer(publicKeyOptions.challenge);
                publicKeyOptions.user.id = base64urlToBuffer(publicKeyOptions.user.id);

                if (publicKeyOptions.excludeCredentials) {
                    for (let cred of publicKeyOptions.excludeCredentials) {
                        cred.id = base64urlToBuffer(cred.id);
                    }
                }

                const credential = await navigator.credentials.create({ publicKey: publicKeyOptions });

                const attestationResponse = {
                    id: credential.id,
                    rawId: bufferToBase64url(credential.rawId),
                    type: credential.type,
                    response: {
                        clientDataJSON: bufferToBase64url(credential.response.clientDataJSON),
                        attestationObject: bufferToBase64url(credential.response.attestationObject)
                    }
                };

                const finishResponse = await fetch('/register/finish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(attestationResponse)
                });

                const finishResult = await finishResponse.json();

                alert('Registration successful!');
            } catch (err) {
                console.error(err);
                alert('Registration failed: ' + err.message);
            }
        }

        async function login() {
            try {
                const response = await fetch('/login/begin', { method: 'POST' });
                const options = await response.json();

                const publicKeyOptions = options.publicKey;

                // Convert Base64URL strings to ArrayBuffers
                publicKeyOptions.challenge = base64urlToBuffer(publicKeyOptions.challenge);

                if (publicKeyOptions.allowCredentials) {
                    for (let cred of publicKeyOptions.allowCredentials) {
                        cred.id = base64urlToBuffer(cred.id);
                    }
                }

                const assertion = await navigator.credentials.get({ publicKey: publicKeyOptions });

                const assertionResponse = {
                    id: assertion.id,
                    rawId: bufferToBase64url(assertion.rawId),
                    type: assertion.type,
                    response: {
                        clientDataJSON: bufferToBase64url(assertion.response.clientDataJSON),
                        authenticatorData: bufferToBase64url(assertion.response.authenticatorData),
                        signature: bufferToBase64url(assertion.response.signature),
                        userHandle: bufferToBase64url(assertion.response.userHandle),
                    }
                };

                const finishResponse = await fetch('/login/finish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(assertionResponse)
                });

                const finishResult = await finishResponse.json();

                alert('Login successful!');
            } catch (err) {
                console.error(err);
                alert('Login failed: ' + err.message);
            }
        }
    </script>
</body>
</html>
